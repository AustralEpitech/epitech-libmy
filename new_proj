#!/usr/bin/bash

set -e
shopt -s dotglob failglob

BOLD="\033[1m"
NORM="\033[0m"

REMOVE="${BOLD}REMOVE${NORM}"
COPY="${BOLD}COPY${NORM}"
REPLACING="${BOLD}REPLACING PROJECT NAME${NORM}"
DONE="${BOLD}DONE${NORM}"

CP="cp -fr"
ECHO="echo -e"
MKDIR="mkdir -p"
RM="rm -fr"

SRC="$(dirname "$0")/repo"
NAME="$1"

while [ -z "$NAME" ]; do
    read -rp "Name: " NAME
done

set +e
FILES="$(echo "$NAME"/* | grep -wv .git)"
set -e
if [ -n "$FILES" ]; then
    read -rp "$NAME exists. Purge content? [Y/n] " ANS
    case "${ANS,,}" in
        "" | y | yes)
            $ECHO "$REMOVE"
            $ECHO "$FILES" | xargs $RM
            ;;
        *)
            exit 1
            ;;
    esac
fi

echo -e "$COPY"
$MKDIR "$NAME"
$CP "$SRC"/* "$NAME"
rename "%%PROJ%%" "$NAME" "$NAME"/**/*

$ECHO "$REPLACING"
find "$NAME" -type "f" ! -path "$NAME/.git/*" -exec sed -i "s/%%PROJ%%/$NAME/g; s/%%PROJ_UP%%/${NAME^^}/g" {} +

$ECHO "$DONE"
