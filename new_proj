#!/usr/bin/bash

set -e
shopt -s dotglob failglob

BOLD="\033[1m"
NORM="\033[0m"

REMOVE="${BOLD}REMOVE${NORM}"
COPY="${BOLD}COPY${NORM}"
REPLACING="${BOLD}REPLACING PROJECT NAME${NORM}"
DONE="${BOLD}DONE${NORM}"

SRC="$(dirname "$0")/repo"
NAME="$1"

while [ -z "$NAME" ]; do
    read -rp "Name: " NAME
done

if [ -n "$(ls -A "$NAME" 2> /dev/null)" ]; then
    FILES="$(echo "$NAME"/* | grep -wv .git)"
fi

if [ -n "$FILES" ]; then
    read -rp "$NAME exists. Purge content? [Y/n] " ANS
    case "${ANS,,}" in
        "" | y | yes)
            echo -e "$REMOVE"
            echo "$FILES" | xargs rm -fr
            ;;
        *)
            exit 1
            ;;
    esac
fi

echo -e "$COPY"
mkdir -p "$NAME"
cp -fr "$SRC"/* "$NAME"
rename "%%PROJ%%" "$NAME" "$NAME"/**/*

echo -e "$REPLACING"
find "$NAME" -type "f" ! -path "$NAME/.git/*" -exec sed -i "s/%%PROJ%%/$NAME/g; s/%%PROJ_UP%%/${NAME^^}/g" {} +

echo -e "$DONE"
